#!/bin/sh
if [ "${DEBUG}" != "0" ]; then
  set -x
fi

set -eu

envsubst '$WEB_SERVER_NAME,$WEB_DEVPI_SERVER,$WEB_PROXY_TIMEOUT,$WEB_CLIENT_MAX_BODY_SIZE' \
         < "/etc/nginx/templates/nginx.conf" \
         > "/etc/nginx/nginx.conf"

if [ "${WEB_DEVPI_LOCKDOWN}" = "0" ]; then
  truncate --size 0 /etc/nginx/include/lockdown.conf
else
  truncate --size 0 /etc/nginx/include/auth.conf
fi

if [ "${DEBUG}" != "0" ]; then
  cat /etc/nginx/nginx.conf
  for f in /etc/nginx/include/*.conf; do
    cat ${f}
    done
fi

exec nginx "$@"
